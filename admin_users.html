{% extends "base.html" %}
{% block title %}Admin - Users{% endblock %}

{% block content %}
<section class="gk-admin">
  <div class="gk-card gk-card--glow" style="max-width: 980px; width: min(980px, 100%);">

    <div class="gk-admin__head">
      <div>
        <h2 class="gk-title" style="margin-bottom: 6px;">Admin Panel</h2>
        <div class="gk-subtitle">Registrazione users</div>
      </div>

      <div style="display:flex; align-items:center; gap:10px;">
        <span class="gk-chip">GymKong</span>
        <a class="gk-btn gk-btn--gold gk-btn--small" href="{{ url_for('logout') }}">Logout</a>
      </div>
    </div>

    <!-- CREATE USER -->
    <div style="margin-top: 14px; margin-bottom: 18px;">
      <h3 style="margin: 0 0 10px 0;">Crea utente</h3>

      <form method="POST" action="{{ url_for('admin_users') }}" class="gk-form" style="gap:8px;">
        {{ create_form.csrf_token }}
        <input type="hidden" name="action" value="create_user">

        <label class="gk-label">Username</label>
        {{ create_form.username(class="gk-input") }}

        <label class="gk-label">Email</label>
        {{ create_form.email(class="gk-input") }}

        <label class="gk-label">Password</label>
        {{ create_form.password(class="gk-input") }}

        <div style="display:flex; align-items:center; gap:10px; margin-top:8px;">
          {{ create_form.is_admin() }}
          <span style="font-weight:800; opacity:.85;">Admin?</span>
        </div>

        <button class="gk-btn gk-btn--gold gk-btn--full" type="submit">Crea utente</button>
      </form>
    </div>

    <!-- TABLE -->
    <div class="gk-tablewrap">
      <table class="gk-table">
        <thead>
          <tr>
            <th style="width:60px;">ID</th>
            <th>Username</th>
            <th>Email</th>
            <th style="width:90px;">Admin</th>
            <th>Password (hash)</th>
            <th style="width:260px;">Azioni</th>
          </tr>
        </thead>

        <tbody>
          {% for u in users %}
          <tr>
            <td>{{ u.id }}</td>
            <td>{{ u.username }}</td>
            <td>{{ u.email }}</td>
            <td>
              {% if u.is_admin %}
                <span class="gk-badge gk-badge--gold">YES</span>
              {% else %}
                <span class="gk-badge">NO</span>
              {% endif %}
            </td>

            <!-- Mostro SOLO hash (accorciato) -->
            <td style="font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size: 12px;">
              {{ u.password_hash[:24] }}...
            </td>

            <td>
              <!-- RESET PASSWORD -->
              <form method="POST"
                    action="{{ url_for('admin_reset_password', user_id=u.id) }}"
                    style="display:inline-block; vertical-align: middle; margin-right:10px;">
                {{ reset_form.csrf_token }}
                <div style="display:flex; gap:8px; align-items:center;">
                  {{ reset_form.new_password(class="gk-input", placeholder="Nuova password", style="width:160px; padding:10px;") }}
                  <button class="gk-btn gk-btn--gold gk-btn--small" type="submit">Reset</button>
                </div>
              </form>

              <!-- DELETE USER -->
              <form method="POST"
                    action="{{ url_for('admin_delete_user', user_id=u.id) }}"
                    style="display:inline-block; vertical-align: middle;"
                    onsubmit="return confirm('Sei sicuro di eliminare questo utente?');">
                {{ reset_form.csrf_token }}
                <button class="gk-btn gk-btn--small" type="submit">Elimina</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>

      </table>
    </div>

    <p class="gk-muted" style="margin-top: 12px;">
      Nota: per sicurezza la password non è visibile. Qui vedi solo l’hash e puoi fare reset.
    </p>

  </div>
</section>
{% endblock %}
